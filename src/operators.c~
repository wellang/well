#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "log.h"

char op_check_buf[0x100];
char *keyword_return;
char *op_check_return;

char *check_keyword(char *string) {
  char *keywords[] = {
    "~if", "~while", "~for"
  };

  int i;
  for(i = 0; i < sizeof(keywords)/sizeof(keywords[0]); i++) {
    char *check = strstr(string, keywords[i]);
    if(check != NULL) {
      keyword_return = check;
      return keyword_return; 
    }
  }

}

char statement_buf[0x100];
char *statement_to_asm(char *string, char *op, bool is_if, bool is_while,
		       const char *funcname, int ifnum_ln, int ifnum) {
  if(is_if == true) {
    const char delim[] = op;
    char *op2 = strstr(string, op);
    if(op2 != NULL) {
      int i;
      for(i = 0; i < sizeof(op); i++) {
	op2++;
      }
      op2++; /*make up for the space between op & op2*/
    }
    char *op1 = strtok(string, delim);
    op1[strlen(op1)-1] = '\0';
    char buf[0x100];
    if(!strcmp(op, eq)) {
      snprintf(buf, sizeof(buf), "\n\t cmp %s, %s\n\t"
	       "je %s_%d_%d%s%s_eq\n\t"
	       "jne %s_%d_%d_fin\n\t"
	       "%s_%d_%d%s%s_eq:",
	       op1, op2,
	       funcname, ifnum_ln, ifnum, op1, op2,
	       funcname, ifnum_ln, ifnum,
	       funcname, ifnum_lb, ifnum, op1, op2);
      statement_buf = buf;
      return statement_buf;
    } else if(!strcmp(op, neq)) {
      snprintf(buf, sizeof(buf), "\n\t cmp %s, %s\n\t"
	       "jne %s_%d_%d%s%s_eq\n\t"
	       "je %s_%d_%d_fin\n\t"
	       "%s_%d_%d%s%s_eq:",
	       op1, op2,
	       funcname, ifnum_ln, ifnum, op1, op2,
	       funcname, ifnum_ln, ifnum,
	       funcname, ifnum_lb, ifnum, op1, op2);
      statement_buf = buf;
      return statement_buf;
    } else if(!strcmp(op, gre)) {
      snprintf(buf, sizeof(buf), "\n\t cmp %s, %s\n\t"
	       "jg %s_%d_%d%s%s_eq\n\t"
	       "jng %s_%d_%d_fin\n\t"
	       "%s_%d_%d%s%s_eq:",
	       op1, op2,
	       funcname, ifnum_ln, ifnum, op1, op2,
	       funcname, ifnum_ln, ifnum,
	       funcname, ifnum_lb, ifnum, op1, op2);
      statement_buf = buf;
      return statement_buf;
    } else if(!strcmp(op, les)) {
      snprintf(buf, sizeof(buf), "\n\t cmp %s, %s\n\t"
	       "jl %s_%d_%d%s%s_eq\n\t"
	       "jnl %s_%d_%d_fin\n\t"
	       "%s_%d_%d%s%s_eq:",
	       op1, op2,
	       funcname, ifnum_ln, ifnum, op1, op2,
	       funcname, ifnum_ln, ifnum,
	       funcname, ifnum_lb, ifnum, op1, op2);
      statement_buf = buf;
      return statement_buf;
    } else if(!strcmp(op, gre_or_eq) {

    }
  } else if(is_while == true) {
    exit(0);
  }
}

char *check_operator(char *string, const char *funcname, int ifnum_ln, int ifnum) {
  
  char *keyword_type = check_keyword(string);

  char *eq_ = strstr(string, eq);
  char *neq_ = strstr(string, neq);
  char *gre_ = strstr(string, gre);
  char *les_ = strstr(string, les);
  char *gre_or_eq_ = strstr(string, gre_or_eq);
  char *les_or_eq_ = strstr(string, les_or_eq);
  if(eq_ == NULL && neq_ == NULL &&
     gre_ == NULL && les_ == NULL &&
     gre_or_eq_ == NULL && les_or_eq_ == NULL) {
    snprintf(op_check_buf, sizeof(op_check_buf), "NO_OP");
    return op_check_buf;
  } else if(eq_ != NULL) {
    char *keyword = check_keyword(string);
    if(!strcmp(keyword, "~if")) {
      const char delim[] = ")";
      char *first = strchr(string, '(');
      if(first != NULL) { first++; }
      char *statement_to_asm = strtok(first, delim);
      char *asm_string = statement_to_asm(string_statement, eq, true, false,
					  funcname, ifnum_ln, ifnum);
      op_check_return = asm_string;
      return op_check_return;
    } else if(!strcmp(keyword, "~while")) {
      exit(0);
    }
  }

}
